<!DOCTYPE html>
<html lang="ru" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>15 Puzzle Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #e5e7eb; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --accent-primary: #4f46e5; /* indigo-600 */
            --accent-primary-hover: #4338ca; /* indigo-700 */
            --accent-secondary: #db2777; /* pink-600 */
            --accent-secondary-hover: #be185d; /* pink-700 */
            --tile-bg: #ffffff;
            --tile-text: #4f46e5;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-backdrop: rgba(17, 24, 39, 0.5);
        }

        html.dark {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #d1d5db; /* gray-300 */
            --accent-primary: #6366f1; /* indigo-500 */
            --accent-primary-hover: #4f46e5; /* indigo-600 */
            --accent-secondary: #f9a8d4; /* pink-300 */
            --accent-secondary-hover: #f472b6; /* pink-400 */
            --tile-bg: #374151;
            --tile-text: #c7d2fe;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --modal-backdrop: rgba(0, 0, 0, 0.7);
        }

        /* Basic Setup & Anti-Selection */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* Disable text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            
            /* Desktop centering */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        /* Main Container for vertical mobile layout */
        .game-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            max-height: 900px; /* Max height for desktop */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px var(--shadow-color);
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
            padding-bottom: 50px; /* Space for banner ad */
        }
        
        @media (min-width: 480px) {
            .game-container {
                height: 95vh;
                border-radius: 20px;
            }
        }


        /* Screen Transitions */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            opacity: 1;
            transform: scale(1);
            will-change: transform, opacity;
            backface-visibility: hidden;
            overflow-y: auto;
        }

        .screen.hidden {
            transform: scale(1.1);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Glassmorphism Modal */
        .modal {
            background-color: var(--modal-backdrop);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Custom Button Styles */
        .btn {
            transition: transform 0.1s ease-out, background-color 0.2s;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-primary:hover {
            background-color: var(--accent-primary-hover);
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn-other-games {
            background-color: var(--accent-secondary);
            color: white;
        }
        .btn-other-games:hover {
             background-color: var(--accent-secondary-hover);
        }


        /* Custom Pastel & Classic Colors */
        .bg-pastel-green { background-color: #dcfce7; }
        .bg-pastel-blue { background-color: #dbeafe; }
        .bg-pastel-yellow { background-color: #fef08a; }
        .bg-pastel-red { background-color: #fee2e2; }
        .text-pastel-green { color: #166534; }
        .text-pastel-blue { color: #1e40af; }
        .text-pastel-yellow { color: #854d0e; }
        .text-pastel-red { color: #991b1b; }

        .bg-classic-1 { background-color: #e0e7ff; }
        .text-classic-1 { color: #3730a3; }
        .bg-classic-2 { background-color: #d1fae5; }
        .text-classic-2 { color: #065f46; }
        .bg-classic-3 { background-color: #fef9c3; }
        .text-classic-3 { color: #854d0e; }
        
        .category-btn .level-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--accent-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            border: 2px solid var(--bg-secondary);
        }

        /* Puzzle Board */
        #puzzle-board {
            aspect-ratio: 1 / 1;
            padding: 4px; /* Reduced gap */
            background-color: var(--bg-tertiary);
            border-radius: 16px;
            touch-action: none;
            position: relative;
        }

        .tile {
            background-color: var(--tile-bg);
            color: var(--tile-text);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            border-radius: 12px;
            cursor: pointer;
            position: absolute;
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            transition: top 0.2s cubic-bezier(0.25, 1, 0.5, 1), left 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: top, left;
        }
        .tile.empty {
            background-color: transparent;
            box-shadow: none;
            pointer-events: none;
        }
        .tile canvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }
        .tile .hint-number {
            position: absolute;
            top: 2px;
            left: 5px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black;
            opacity: 0.8;
            pointer-events: none;
        }
        
    </style>
</head>
<body class="overflow-hidden" oncontextmenu="return false;">

    <div id="game-container" class="game-container">

        <!-- ===== Main Menu Screen ===== -->
        <div id="main-menu" class="screen flex flex-col justify-between p-8">
            <header class="text-center">
                <h1 class="text-8xl font-extrabold tracking-tighter text-[var(--accent-primary)]">15</h1>
                <p class="text-5xl font-bold tracking-tight text-[var(--text-primary)]">Puzzle</p>
            </header>
            
            <main class="flex-grow flex flex-col justify-center gap-4 my-8">
                <button data-mode="classic" class="game-mode-btn btn btn-primary w-full py-4 rounded-xl text-lg font-bold">Классика</button>
                <button data-mode="category" class="game-mode-btn btn btn-secondary w-full py-4 rounded-xl text-lg font-bold">Категории</button>
                <button id="custom-photo-btn" class="btn btn-secondary w-full py-4 rounded-xl text-lg font-bold">Своё фото</button>
                <button id="other-games-btn" class="btn btn-other-games w-full py-4 rounded-xl text-lg font-bold mt-4">Другие игры</button>
                <input type="file" id="image-loader" class="hidden" accept="image/*">
            </main>

            <footer class="flex justify-center gap-4">
                <button id="rules-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="stats-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </button>
                <button id="settings-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </footer>
        </div>

        <!-- ===== Classic Mode Size Selection Screen ===== -->
        <div id="classic-menu" class="screen hidden flex flex-col p-8">
            <header class="flex items-center mb-8">
                <button id="back-to-main-from-classic" class="btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-center flex-grow -ml-12">Размер поля</h2>
            </header>
            <main class="flex-grow flex flex-col justify-center gap-4">
                 <button data-size="4" class="classic-size-btn btn bg-classic-1 text-classic-1 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">4 x 4</button>
                 <button data-size="5" class="classic-size-btn btn bg-classic-2 text-classic-2 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">5 x 5</button>
                 <button data-size="6" class="classic-size-btn btn bg-classic-3 text-classic-3 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">6 x 6</button>
            </main>
        </div>
        
        <!-- ===== Category Selection Screen ===== -->
        <div id="category-menu" class="screen hidden flex flex-col p-8">
            <header class="flex items-center mb-8">
                <button id="back-to-main-from-cat" class="btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-center flex-grow -ml-12">Категории</h2>
            </header>
            <main class="flex-grow grid grid-cols-2 gap-4">
                 <button data-category="animals" class="relative category-btn btn bg-pastel-green text-pastel-green w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">Животные</button>
                 <button data-category="nature" class="relative category-btn btn bg-pastel-blue text-pastel-blue w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">Природа</button>
                 <button data-category="cities" class="relative category-btn btn bg-pastel-yellow text-pastel-yellow w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">Города</button>
                 <button data-category="cars" class="relative category-btn btn bg-pastel-red text-pastel-red w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">Автомобили</button>
            </main>
        </div>

        <!-- ===== Game Screen ===== -->
        <div id="game-screen" class="screen hidden flex flex-col justify-between p-4 sm:p-6">
            <header class="flex justify-between items-center w-full mb-4">
                <button id="pause-btn" class="btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <div class="flex gap-6 text-center">
                    <div>
                        <div class="text-sm font-medium text-[var(--text-secondary)]">Время</div>
                        <div id="timer" class="text-xl font-bold">00:00</div>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-[var(--text-secondary)]">Ходы</div>
                        <div id="moves" class="text-xl font-bold">0</div>
                    </div>
                </div>
                <div id="image-preview-container" class="w-24 h-24 rounded-lg overflow-hidden shadow-md bg-[var(--bg-tertiary)]"></div>
            </header>
            
            <main class="flex-grow flex items-center justify-center">
                <div id="puzzle-board-container" class="w-full max-w-md mx-auto">
                    <div id="puzzle-board"></div>
                </div>
            </main>

            <footer id="game-footer" class="h-16 flex items-center justify-center opacity-0 transition-opacity duration-300">
                <div class="flex items-center gap-4 bg-[var(--bg-tertiary)] py-2 px-4 rounded-full">
                    <span class="font-semibold text-sm text-[var(--text-secondary)]">Подсказка</span>
                     <button id="hint-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-[var(--bg-primary)]">
                        <span id="hint-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                    </button>
                </div>
            </footer>
        </div>

        <!-- ===== Modals ===== -->
        <div id="rules-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-4">Правила игры</h2>
                <p class="text-[var(--text-secondary)] mb-4 text-center">
                    Цель игры — упорядочить плитки по номерам. Нажимайте на плитки рядом с пустым местом, чтобы переместить их.
                </p>
                <div id="rules-grid-example" class="aspect-square bg-[var(--bg-tertiary)] rounded-lg p-2 grid grid-cols-4 gap-1"></div>
                <button id="close-rules-btn" class="btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">Понятно</button>
            </div>
        </div>
        
        <div id="other-games-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Другие игры</h2>
                <div id="other-games-container" class="grid grid-cols-3 gap-4"></div>
                <button id="close-other-games-btn" class="btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">Закрыть</button>
            </div>
        </div>

        <div id="stats-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-4">Статистика (Классика)</h2>
                <div id="stats-container" class="space-y-4"></div>
                <button id="close-stats-btn" class="btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">Закрыть</button>
            </div>
        </div>

        <div id="settings-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Настройки</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">Тёмная тема</span>
                        <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-[var(--bg-primary)]">
                            <span id="theme-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">Музыка</span>
                        <button id="music-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-[var(--bg-primary)]">
                            <span id="music-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">Звуки</span>
                        <button id="sfx-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-[var(--bg-primary)]">
                            <span id="sfx-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                        </button>
                    </div>
                </div>
                <button id="close-settings-btn" class="btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">Готово</button>
            </div>
        </div>

        <div id="pause-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-8 rounded-2xl shadow-lg text-center">
                <h2 class="text-3xl font-bold mb-6">Пауза</h2>
                <div class="space-y-4">
                     <button id="resume-game-btn" class="btn btn-primary w-full py-3 rounded-lg font-semibold">Продолжить</button>
                     <button id="restart-game-btn-pause" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">Начать заново</button>
                     <button id="exit-to-menu-btn-pause" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">Выйти в меню</button>
                </div>
            </div>
        </div>

        <div id="win-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-8 rounded-2xl shadow-lg text-center">
                <div class="mb-4"><span class="text-6xl">🎉</span></div>
                <h2 class="text-3xl font-bold mb-2">Победа!</h2>
                <p id="win-subtitle" class="text-[var(--text-secondary)] mb-6">Отличная работа!</p>
                <div class="flex justify-around bg-[var(--bg-tertiary)] p-4 rounded-lg mb-6">
                    <div class="text-center">
                        <div class="text-sm font-medium text-[var(--text-secondary)]">Время</div>
                        <div id="win-time" class="text-xl font-bold">00:00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-[var(--text-secondary)]">Ходы</div>
                        <div id="win-moves" class="text-xl font-bold">0</div>
                    </div>
                </div>
                 <div class="space-y-4">
                     <button id="next-level-btn-win" class="btn btn-primary w-full py-3 rounded-lg font-semibold">Следующий уровень</button>
                     <button id="restart-game-btn-win" class="btn btn-primary w-full py-3 rounded-lg font-semibold">Играть снова</button>
                     <button id="exit-to-menu-btn-win" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">Выйти в меню</button>
                </div>
            </div>
        </div>

        <div id="alert-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg text-center">
                 <h2 id="alert-title" class="text-2xl font-bold mb-4">Поздравляем!</h2>
                 <p id="alert-text" class="text-[var(--text-secondary)] mb-6"></p>
                 <button id="close-alert-btn" class="btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">Отлично</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            vkBridge.send('VKWebAppInit');

            // --- DOM Elements ---
            const ALL_SCREENS = {
                mainMenu: document.getElementById('main-menu'),
                classicMenu: document.getElementById('classic-menu'),
                categoryMenu: document.getElementById('category-menu'),
                game: document.getElementById('game-screen'),
            };
            const ALL_MODALS = {
                rules: document.getElementById('rules-modal'),
                stats: document.getElementById('stats-modal'),
                settings: document.getElementById('settings-modal'),
                pause: document.getElementById('pause-modal'),
                win: document.getElementById('win-modal'),
                alert: document.getElementById('alert-modal'),
                otherGames: document.getElementById('other-games-modal'),
            };
            const puzzleBoard = document.getElementById('puzzle-board');
            const timerEl = document.getElementById('timer');
            const movesEl = document.getElementById('moves');
            const imageLoader = document.getElementById('image-loader');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const gameFooter = document.getElementById('game-footer');
            const bgMusic = document.getElementById('bg-music');

            // --- Game State ---
            let state = {
                currentScreen: 'mainMenu', gameMode: null, category: null, currentLevel: 1,
                gridSize: 4, customImageSrc: null, board: [], emptyTile: { row: 3, col: 3 },
                moves: 0, timer: 0, timerInterval: null, isPaused: false, isGameActive: false,
                isRendering: false, sfxEnabled: true, musicEnabled: true, hintsEnabled: false,
                levelsCompletedSinceAd: 0,
            };

            const CATEGORIES_DATA = {
                animals: { name: 'Животные', path: 'images/animals/' },
                nature: { name: 'Природа', path: 'images/nature/' },
                cities: { name: 'Города', path: 'images/cities/' },
                cars: { name: 'Автомобили', path: 'images/cars/' }
            };

            const BOARD_PADDING = 4;
            const TILE_GAP = 4;

            // --- Sound Engine ---
            let sfxTap, sfxSlide, sfxWin;
            const initAudio = () => {
                if (sfxTap) return;
                sfxTap = new Tone.FMSynth({ harmonicity: 8, modulationIndex: 2, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.2 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 }, volume: -18 }).toDestination();
                sfxSlide = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 }, volume: -18 }).toDestination();
                sfxWin = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 3.01, modulationIndex: 14, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, volume: -10 }).toDestination();
            };
            
            const playSound = (sound) => {
                if (!state.sfxEnabled || Tone.context.state === 'suspended') return;
                initAudio();
                const now = Tone.now();
                if (sound === 'tap') sfxTap.triggerAttackRelease("C5", "8n", now);
                if (sound === 'slide') sfxSlide.triggerAttackRelease("A5", "32n", now);
                if (sound === 'win') sfxWin.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n", now);
            };
            
             // --- VK Bridge & Data Storage ---
            const saveData = (key, value) => {
                vkBridge.send('VKWebAppStorageSet', { key: key, value: JSON.stringify(value) })
                    .catch(error => console.error(`Error saving ${key}:`, error));
            };

            const loadData = async (keys) => {
                try {
                    const data = await vkBridge.send('VKWebAppStorageGet', { keys: keys });
                    const result = {};
                    keys.forEach(key => {
                        const item = data.keys.find(d => d.key === key);
                        if (item && item.value) {
                            try {
                                result[key] = JSON.parse(item.value);
                            } catch (e) { result[key] = item.value; }
                        }
                    });
                    return result;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return {};
                }
            };

            // --- Image Handling ---
            const loadAndCropImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const size = Math.min(img.width, img.height);
                        const canvas = document.createElement('canvas');
                        canvas.width = size; canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        const x = (img.width - size) / 2;
                        const y = (img.height - size) / 2;
                        ctx.drawImage(img, x, y, size, size, 0, 0, size, size);
                        resolve(canvas.toDataURL());
                    };
                    img.onerror = () => reject(new Error('Image could not be loaded.'));
                    img.src = src;
                });
            };

            // --- Game Logic ---
            const initGame = (mode, options) => {
                state.gameMode = mode;
                state.category = options.category || null;
                state.currentLevel = options.level || 1;
                state.customImageSrc = options.imageSrc || null;
                state.gridSize = options.size || 4;
                gameFooter.classList.toggle('opacity-0', mode !== 'image');
                updateGameHeader();
                resetGameState();
                generateBoard();
                showScreen('game');
                requestAnimationFrame(() => rerenderBoard(startGame));
            };

            const updateGameHeader = () => {
                imagePreviewContainer.innerHTML = '';
                if (state.gameMode === 'image' && state.customImageSrc) {
                    const img = document.createElement('img');
                    img.src = state.customImageSrc;
                    img.className = 'w-full h-full object-cover';
                    imagePreviewContainer.appendChild(img);
                    imagePreviewContainer.classList.remove('hidden');
                } else {
                    imagePreviewContainer.classList.add('hidden');
                }
            };

            const resetGameState = () => {
                state.moves = 0; state.timer = 0; state.isPaused = false; state.isGameActive = true;
                movesEl.textContent = '0';
                timerEl.textContent = '00:00';
                clearInterval(state.timerInterval);
            };

            const generateBoard = () => {
                const TILE_COUNT = state.gridSize * state.gridSize;
                state.board = Array.from({ length: state.gridSize }, (_, r) => Array.from({ length: state.gridSize }, (_, c) => r * state.gridSize + c + 1));
                state.board[state.gridSize - 1][state.gridSize - 1] = TILE_COUNT;
                state.emptyTile = { row: state.gridSize - 1, col: state.gridSize - 1 };
                for (let i = 0; i < TILE_COUNT * 10; i++) {
                    const neighbors = getNeighbors(state.emptyTile.row, state.emptyTile.col);
                    const randNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                    [state.board[state.emptyTile.row][state.emptyTile.col], state.board[randNeighbor.row][randNeighbor.col]] = [state.board[randNeighbor.row][randNeighbor.col], state.board[state.emptyTile.row][state.emptyTile.col]];
                    state.emptyTile = randNeighbor;
                }
            };
            
            const rerenderBoard = (callback) => {
                if (state.isRendering) return;
                state.isRendering = true;
                if (state.gameMode === 'image' && state.customImageSrc) renderImageBoard(callback);
                else {
                    renderClassicBoard();
                    state.isRendering = false;
                    if (callback) callback();
                }
            };

            const getTileMetrics = () => {
                const boardSize = puzzleBoard.clientWidth - (BOARD_PADDING * 2);
                const tileSize = (boardSize - (TILE_GAP * (state.gridSize - 1))) / state.gridSize;
                return { tileSize };
            };

            const getTilePosition = (row, col, tileSize) => ({
                top: BOARD_PADDING + row * (tileSize + TILE_GAP),
                left: BOARD_PADDING + col * (tileSize + TILE_GAP)
            });
            
            const renderClassicBoard = () => {
                puzzleBoard.innerHTML = '';
                const { tileSize } = getTileMetrics();
                const TILE_COUNT = state.gridSize * state.gridSize;
                for (let row = 0; row < state.gridSize; row++) {
                    for (let col = 0; col < state.gridSize; col++) {
                        const tileValue = state.board[row][col];
                        const tile = document.createElement('div');
                        tile.className = 'tile';
                        if (tileValue === TILE_COUNT) tile.classList.add('empty');
                        else tile.textContent = tileValue;
                        tile.style.fontSize = `${tileSize * 0.4}px`;
                        const { top, left } = getTilePosition(row, col, tileSize);
                        Object.assign(tile.style, { width: `${tileSize}px`, height: `${tileSize}px`, top: `${top}px`, left: `${left}px` });
                        Object.assign(tile.dataset, { row, col });
                        puzzleBoard.appendChild(tile);
                    }
                }
            };

            const renderImageBoard = (callback) => {
                puzzleBoard.innerHTML = '';
                const { tileSize } = getTileMetrics();
                const TILE_COUNT = state.gridSize * state.gridSize;
                const img = new Image();
                img.onload = () => {
                    const pieceSize = img.width / state.gridSize;
                    for (let row = 0; row < state.gridSize; row++) {
                        for (let col = 0; col < state.gridSize; col++) {
                            const tileValue = state.board[row][col];
                            const tile = document.createElement('div');
                            tile.className = 'tile';
                            if (tileValue === TILE_COUNT) tile.classList.add('empty');
                            else {
                                const canvas = document.createElement('canvas');
                                canvas.width = pieceSize; canvas.height = pieceSize;
                                const ctx = canvas.getContext('2d');
                                const sX = ((tileValue - 1) % state.gridSize) * pieceSize;
                                const sY = Math.floor((tileValue - 1) / state.gridSize) * pieceSize;
                                ctx.drawImage(img, sX, sY, pieceSize, pieceSize, 0, 0, pieceSize, pieceSize);
                                tile.appendChild(canvas);
                                if (state.hintsEnabled) {
                                    const hint = document.createElement('span');
                                    hint.className = 'hint-number';
                                    hint.textContent = tileValue;
                                    hint.style.fontSize = `${tileSize * 0.2}px`;
                                    tile.appendChild(hint);
                                }
                            }
                            const { top, left } = getTilePosition(row, col, tileSize);
                            Object.assign(tile.style, { width: `${tileSize}px`, height: `${tileSize}px`, top: `${top}px`, left: `${left}px` });
                            Object.assign(tile.dataset, { row, col, value: tileValue });
                            puzzleBoard.appendChild(tile);
                        }
                    }
                    state.isRendering = false;
                    if (callback) callback();
                };
                img.onerror = () => {
                    showAlert("Ошибка", "Не удалось загрузить изображение.");
                    state.isRendering = false;
                    showScreen('mainMenu');
                };
                img.src = state.customImageSrc;
            };
            
            const onTileClick = (row, col) => {
                if (state.isPaused || !state.isGameActive) return;
                const { emptyTile } = state;
                const isAdjacent = Math.abs(row - emptyTile.row) + Math.abs(col - emptyTile.col) === 1;
                if (isAdjacent) {
                    playSound('slide');
                    swapTiles(row, col, emptyTile.row, emptyTile.col);
                }
            };

            const swapTiles = (row1, col1, row2, col2) => {
                [state.board[row1][col1], state.board[row2][col2]] = [state.board[row2][col2], state.board[row1][col1]];
                const tile1 = puzzleBoard.querySelector(`[data-row='${row1}'][data-col='${col1}']`);
                const tile2 = puzzleBoard.querySelector(`[data-row='${row2}'][data-col='${col2}']`);
                if (!tile1 || !tile2) return;

                const { tileSize } = getTileMetrics();
                const pos1 = getTilePosition(row1, col1, tileSize);
                const pos2 = getTilePosition(row2, col2, tileSize);
                
                Object.assign(tile1.style, { top: `${pos2.top}px`, left: `${pos2.left}px` });
                Object.assign(tile1.dataset, { row: row2, col: col2 });
                Object.assign(tile2.style, { top: `${pos1.top}px`, left: `${pos1.left}px` });
                Object.assign(tile2.dataset, { row: row1, col: col1 });
                
                state.emptyTile = { row: row1, col: col1 };
                updateMoves();
                if (checkWin()) endGame(true);
            };

            const getNeighbors = (r, c) => [{r:r-1,c},{r:r+1,c},{r,c:c-1},{r,c:c+1}].filter(({r,c})=>r>=0&&r<state.gridSize&&c>=0&&c<state.gridSize);
            const updateMoves = () => movesEl.textContent = ++state.moves;

            const checkWin = () => state.board.flat().every((val, i) => val === i + 1);
            
            const startGame = () => { state.isGameActive = true; startTimer(); };

            const endGame = (isWin) => {
                state.isGameActive = false;
                clearInterval(state.timerInterval);
                if (isWin) {
                    playSound('win');
                    document.getElementById('win-time').textContent = formatTime(state.timer);
                    document.getElementById('win-moves').textContent = state.moves;
                    const isCategoryMode = state.gameMode === 'image' && state.category;
                    document.getElementById('next-level-btn-win').classList.toggle('hidden', !isCategoryMode);
                    document.getElementById('restart-game-btn-win').classList.toggle('hidden', isCategoryMode);

                    if (isCategoryMode) {
                        document.getElementById('win-subtitle').textContent = `Уровень ${state.currentLevel} пройден!`;
                        saveCategoryProgress(state.category, state.currentLevel + 1);
                    } else {
                        document.getElementById('win-subtitle').textContent = `Отличная работа!`;
                    }
                    if (state.gameMode === 'classic') saveClassicStats();
                    
                    state.levelsCompletedSinceAd++;
                    if (state.levelsCompletedSinceAd >= 2) {
                        vkBridge.send('VKWebAppShowInterstitial').catch(e => console.log(e));
                        state.levelsCompletedSinceAd = 0;
                    }
                    saveData('levelsCompleted', state.levelsCompletedSinceAd);

                    showModal('win');
                }
            };

            const startTimer = () => {
                clearInterval(state.timerInterval);
                state.timerInterval = setInterval(() => {
                    if (!state.isPaused) timerEl.textContent = formatTime(++state.timer);
                }, 1000);
            };

            const formatTime = (s) => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            const showScreen = (name) => Object.keys(ALL_SCREENS).forEach(key => ALL_SCREENS[key].classList.toggle('hidden', key !== name));
            const showAlert = (title, text) => {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-text').textContent = text;
                showModal('alert');
            };
            const showModal = (name) => ALL_MODALS[name].classList.remove('hidden');
            const hideModal = (name) => ALL_MODALS[name].classList.add('hidden');
            const hideAllModals = () => Object.values(ALL_MODALS).forEach(m => m.classList.add('hidden'));

            // --- Event Listeners Setup ---
            const setupListeners = () => {
                // Delegated listener for tiles
                puzzleBoard.addEventListener('click', (e) => {
                    if (state.isPaused || !state.isGameActive) return;
                    const tile = e.target.closest('.tile:not(.empty)');
                    if (tile) {
                        onTileClick(parseInt(tile.dataset.row), parseInt(tile.dataset.col));
                    }
                });
                
                // All other buttons
                document.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => playSound('tap')));

                document.querySelectorAll('.game-mode-btn').forEach(btn => btn.addEventListener('click', () => {
                    if (btn.dataset.mode === 'category') updateCategoryLevels();
                    showScreen(btn.dataset.mode + 'Menu');
                }));
                document.querySelectorAll('.classic-size-btn').forEach(btn => btn.addEventListener('click', () => initGame('classic', { size: parseInt(btn.dataset.size) })));
                document.querySelectorAll('.category-btn').forEach(btn => btn.addEventListener('click', async () => {
                    const category = btn.dataset.category;
                    const progress = await getCategoryProgress();
                    const level = progress[category] || 1;
                    if (level > 60) {
                        showAlert('Поздравляем!', `Вы прошли все уровни в категории "${CATEGORIES_DATA[category].name}".`);
                        return;
                    }
                    const size = level <= 20 ? 4 : (level <= 40 ? 5 : 6);
                    try {
                        const croppedImageSrc = await loadAndCropImage(`${CATEGORIES_DATA[category].path}${level}.jpg`);
                        initGame('image', { category, imageSrc: croppedImageSrc, size, level });
                    } catch (error) { showAlert('Ошибка загрузки', 'Не удалось загрузить изображение.'); }
                }));

                document.getElementById('custom-photo-btn').addEventListener('click', () => imageLoader.click());
                imageLoader.addEventListener('change', e => {
                    if (!e.target.files[0]) return;
                    const reader = new FileReader();
                    reader.onload = async event => {
                        try {
                            const croppedImageSrc = await loadAndCropImage(event.target.result);
                            initGame('image', { imageSrc: croppedImageSrc, size: 4 });
                        } catch (error) { showAlert('Ошибка файла', 'Не удалось обработать изображение.'); }
                    };
                    reader.readAsDataURL(e.target.files[0]);
                    e.target.value = ''; // Reset file input
                });

                const addNavListener = (id, screen) => document.getElementById(id).addEventListener('click', () => showScreen(screen));
                addNavListener('back-to-main-from-cat', 'mainMenu');
                addNavListener('back-to-main-from-classic', 'mainMenu');
                
                const addModalListener = (btnId, modalName, action) => document.getElementById(btnId).addEventListener('click', () => action(modalName));
                addModalListener('rules-btn', 'rules', showModal);
                addModalListener('close-rules-btn', 'rules', hideModal);
                addModalListener('stats-btn', 'stats', name => { renderStats(); showModal(name); });
                addModalListener('close-stats-btn', 'stats', hideModal);
                addModalListener('settings-btn', 'settings', showModal);
                addModalListener('close-settings-btn', 'settings', hideModal);
                addModalListener('close-alert-btn', 'alert', hideModal);
                addModalListener('other-games-btn', 'otherGames', showModal);
                addModalListener('close-other-games-btn', 'otherGames', hideModal);
                
                addModalListener('pause-btn', 'pause', name => { state.isPaused = true; showModal(name); });
                addModalListener('resume-game-btn', 'pause', name => { state.isPaused = false; hideModal(name); });

                const restartGame = () => { hideAllModals(); initGame(state.gameMode, { size: state.gridSize, category: state.category, level: state.currentLevel, imageSrc: state.customImageSrc }); };
                document.getElementById('restart-game-btn-pause').addEventListener('click', restartGame);
                document.getElementById('restart-game-btn-win').addEventListener('click', restartGame);

                document.getElementById('next-level-btn-win').addEventListener('click', async () => {
                    hideAllModals();
                    const nextLevel = state.currentLevel + 1;
                    if (nextLevel > 60) {
                        showAlert('Поздравляем!', `Вы прошли все уровни в категории "${CATEGORIES_DATA[state.category].name}".`);
                        showScreen('mainMenu');
                        return;
                    }
                    const size = nextLevel <= 20 ? 4 : (nextLevel <= 40 ? 5 : 6);
                    try {
                        const croppedImageSrc = await loadAndCropImage(`${CATEGORIES_DATA[state.category].path}${nextLevel}.jpg`);
                        initGame('image', { category: state.category, imageSrc: croppedImageSrc, size, level: nextLevel });
                    } catch (error) { showAlert('Ошибка загрузки', 'Не удалось загрузить следующий уровень.'); showScreen('mainMenu'); }
                });

                const exitToMenu = () => { hideAllModals(); showScreen('mainMenu'); };
                document.getElementById('exit-to-menu-btn-pause').addEventListener('click', exitToMenu);
                document.getElementById('exit-to-menu-btn-win').addEventListener('click', exitToMenu);
            };

            // --- Toggles ---
            const setupToggle = (toggleEl, indicatorEl, initialValue, onToggle) => {
                let isEnabled = initialValue;
                const applyState = (enabled) => {
                    indicatorEl.style.transform = enabled ? 'translateX(1.5rem)' : 'translateX(0.25rem)';
                    toggleEl.classList.toggle('bg-[var(--accent-primary)]', enabled);
                    toggleEl.classList.toggle('bg-[var(--bg-primary)]', !enabled);
                    onToggle(enabled);
                };
                applyState(isEnabled);
                toggleEl.addEventListener('click', () => { isEnabled = !isEnabled; applyState(isEnabled); });
            };

            // --- Category & Stats Logic ---
            const getCategoryProgress = async () => (await loadData(['puzzle-progress']))['puzzle-progress'] || {};
            const saveCategoryProgress = async (category, level) => {
                const progress = await getCategoryProgress();
                progress[category] = level;
                saveData('puzzle-progress', progress);
            };
            const updateCategoryLevels = async () => {
                const progress = await getCategoryProgress();
                document.querySelectorAll('.category-btn').forEach(btn => {
                    const category = btn.dataset.category;
                    const level = progress[category] || 1;
                    let badge = btn.querySelector('.level-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'level-badge';
                        btn.appendChild(badge);
                    }
                    badge.textContent = `Ур. ${level}`;
                });
            };

            const getClassicStats = async () => (await loadData(['puzzle-stats-classic']))['puzzle-stats-classic'] || {};
            const saveClassicStats = async () => {
                const stats = await getClassicStats();
                const key = `classic-${state.gridSize}x${state.gridSize}`;
                const current = stats[key] || { bestTime: null, wins: 0 };
                if (current.bestTime === null || state.timer < current.bestTime) current.bestTime = state.timer;
                current.wins++;
                stats[key] = current;
                saveData('puzzle-stats-classic', stats);
            };

            const renderStats = async () => {
                const stats = await getClassicStats();
                const container = document.getElementById('stats-container');
                const modes = { 'classic-4x4': '4x4', 'classic-5x5': '5x5', 'classic-6x6': '6x6' };
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="text-xs text-[var(--text-secondary)] uppercase"><tr><th scope="col" class="py-2 px-2">Размер</th><th scope="col" class="py-2 px-2 text-center">Побед</th><th scope="col" class="py-2 px-2 text-center">Лучшее время</th></tr></thead><tbody>`;
                for (const key in modes) {
                    const data = stats[key] || { wins: 0, bestTime: null };
                    tableHTML += `<tr class="border-t border-[var(--bg-tertiary)]"><td class="py-3 px-2 font-bold">${modes[key]}</td><td class="py-3 px-2 text-center">${data.wins}</td><td class="py-3 px-2 text-center">${data.bestTime !== null ? formatTime(data.bestTime) : '-'}</td></tr>`;
                }
                container.innerHTML = tableHTML + `</tbody></table></div>`;
            };

            // --- Other Games ---
            const renderOtherGames = () => {
                const games = [
                    { id: 51829672, name: 'Составь слова', icon: 'words.png' }, { id: 51830291, name: 'Филворды', icon: 'fillwords.png' },
                    { id: 51829878, name: 'Сканворды', icon: 'scanwords.png' }, { id: 51830501, name: 'Судоку', icon: 'sudoku.png' },
                    { id: 51830416, name: 'Пасьянс Паук', icon: 'spider.png' }, { id: 51830349, name: 'Пасьянс Косынка', icon: 'klondike.png' },
                    { id: 51830177, name: 'Три в ряд', icon: 'match3.png' }, { id: 51830098, name: 'Поиск слов', icon: 'wordsearch.png' },
                    { id: 51829986, name: 'Угадай слово', icon: 'guessword.png' }
                ];
                const container = document.getElementById('other-games-container');
                container.innerHTML = games.map(game => `
                    <div class="text-center">
                        <button data-appid="${game.id}" class="other-game-btn w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded-2xl flex items-center justify-center shadow-md">
                            <img src="icons/${game.icon}" alt="${game.name}" class="w-16 h-16">
                        </button>
                        <p class="text-sm mt-2 font-medium">${game.name}</p>
                    </div>
                `).join('');
                document.querySelectorAll('.other-game-btn').forEach(btn => {
                    btn.addEventListener('click', () => vkBridge.send('VKWebAppOpenApp', { app_id: parseInt(btn.dataset.appid) }));
                });
            };
            
            // --- Initialization ---
            const initializeApp = async () => {
                const storedData = await loadData(['theme', 'musicEnabled', 'sfxEnabled', 'levelsCompleted']);
                
                const html = document.documentElement;
                const isDark = storedData.theme !== false;
                html.classList.toggle('dark', isDark);
                html.classList.toggle('light', !isDark);

                state.musicEnabled = storedData.musicEnabled !== false;
                state.sfxEnabled = storedData.sfxEnabled !== false;
                state.levelsCompletedSinceAd = storedData.levelsCompleted || 0;

                const setupPersistentToggle = (toggleId, indicatorId, storageKey, initialValue, onToggle) => {
                    const toggle = document.getElementById(toggleId);
                    const indicator = document.getElementById(indicatorId);
                    setupToggle(toggle, indicator, initialValue, isEnabled => {
                        state[storageKey] = isEnabled;
                        saveData(storageKey, isEnabled);
                        onToggle(isEnabled);
                    });
                };

                setupPersistentToggle('theme-toggle', 'theme-toggle-indicator', 'theme', isDark, isDark => {
                    html.classList.toggle('dark', isDark);
                    html.classList.toggle('light', !isDark);
                });
                setupPersistentToggle('music-toggle', 'music-toggle-indicator', 'musicEnabled', state.musicEnabled, isEnabled => isEnabled ? bgMusic.play().catch(e=>e) : bgMusic.pause());
                setupPersistentToggle('sfx-toggle', 'sfx-toggle-indicator', 'sfxEnabled', state.sfxEnabled, isEnabled => {});
                
                const hintToggle = document.getElementById('hint-toggle');
                const hintIndicator = document.getElementById('hint-toggle-indicator');
                setupToggle(hintToggle, hintIndicator, state.hintsEnabled, isEnabled => {
                    state.hintsEnabled = isEnabled;
                    if (state.isGameActive && state.gameMode === 'image') rerenderBoard();
                });

                if (state.musicEnabled) bgMusic.play().catch(e=>e);
                
                vkBridge.subscribe(e => {
                    if (e.detail.type === 'VKWebAppViewLeave') bgMusic.pause();
                    if (e.detail.type === 'VKWebAppViewRestore' && state.musicEnabled) bgMusic.play().catch(e=>e);
                });

                vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(error => console.log(error));
                    
                const container = document.getElementById('rules-grid-example');
                for (let i = 1; i <= 15; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'bg-[var(--bg-secondary)] rounded-md flex items-center justify-center font-bold text-[var(--accent-primary)]';
                    cell.textContent = i;
                    container.appendChild(cell);
                }
                
                renderOtherGames();
                setupListeners();
            };

            initializeApp();
        });
    </script>
</body>
</html>

