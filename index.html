<!DOCTYPE html>
<html lang="ru" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>15 Puzzle Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --accent-primary: #4f46e5;
            --accent-primary-hover: #4338ca;
            --accent-secondary: #10b981; /* Emerald 500 */
            --accent-secondary-hover: #059669; /* Emerald 600 */
            --tile-bg: #ffffff;
            --tile-text: #4f46e5;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-backdrop: rgba(17, 24, 39, 0.5);
        }

        html.dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-primary: #6366f1;
            --accent-primary-hover: #4f46e5;
            --accent-secondary: #34d399; /* Emerald 400 */
            --accent-secondary-hover: #10b981; /* Emerald 500 */
            --tile-bg: #374151;
            --tile-text: #c7d2fe;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --modal-backdrop: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .game-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            height: -webkit-fill-available;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px var(--shadow-color);
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            opacity: 1;
            transform: scale(1);
            will-change: transform, opacity;
            backface-visibility: hidden;
            overflow-y: auto;
            padding-bottom: 50px; /* Space for banner ad */
        }

        .screen.hidden {
            transform: scale(1.1);
            opacity: 0;
            pointer-events: none;
        }
        
        .modal {
            background-color: var(--modal-backdrop);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .btn {
            transition: transform 0.1s ease-out, background-color 0.2s;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-primary:hover {
            background-color: var(--accent-primary-hover);
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn-other-games {
             background-color: var(--accent-secondary);
             color: white;
             box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.39);
        }
        .btn-other-games:hover {
            background-color: var(--accent-secondary-hover);
        }

        .bg-pastel-green { background-color: #dcfce7; }
        .bg-pastel-blue { background-color: #dbeafe; }
        .bg-pastel-yellow { background-color: #fef08a; }
        .bg-pastel-red { background-color: #fee2e2; }
        .text-pastel-green { color: #166534; }
        .text-pastel-blue { color: #1e40af; }
        .text-pastel-yellow { color: #854d0e; }
        .text-pastel-red { color: #991b1b; }

        .bg-classic-1 { background-color: #e0e7ff; }
        .text-classic-1 { color: #3730a3; }
        .bg-classic-2 { background-color: #d1fae5; }
        .text-classic-2 { color: #065f46; }
        .bg-classic-3 { background-color: #fef9c3; }
        .text-classic-3 { color: #854d0e; }

        #puzzle-board {
            aspect-ratio: 1 / 1;
            padding: 4px;
            background-color: var(--bg-tertiary);
            border-radius: 12px;
            touch-action: none;
            position: relative;
        }

        .tile {
            background-color: var(--tile-bg);
            color: var(--tile-text);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            border-radius: 8px; /* Slightly smaller radius */
            cursor: pointer;
            user-select: none;
            position: absolute;
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            transition: top 0.2s cubic-bezier(0.25, 1, 0.5, 1), left 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: top, left;
        }
        .tile.empty {
            background-color: transparent;
            box-shadow: none;
            pointer-events: none;
        }
        .tile canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        .tile .hint-number {
            position: absolute;
            top: 2px;
            left: 5px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black;
            opacity: 0.8;
            pointer-events: none;
        }
        
        .rules-grid-cell {
            font-size: 1rem;
        }
        .category-btn .level-display {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            background-color: rgba(0,0,0,0.1);
        }
        .settings-toggle {
            width: 2.75rem; /* w-11 */
            height: 1.5rem; /* h-6 */
            padding: 0.25rem; /* p-1 */
        }
        .settings-toggle-indicator {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
        }
    </style>
</head>
<body class="overflow-hidden">
    <audio id="bg-music" src="music.mp3" loop></audio>

    <div id="game-container" class="game-container">

        <!-- ===== Main Menu Screen ===== -->
        <div id="main-menu" class="screen flex flex-col justify-between p-8">
            <header class="text-center">
                <h1 class="text-8xl font-extrabold tracking-tighter text-[var(--accent-primary)]">15</h1>
                <p class="text-5xl font-bold tracking-tight text-[var(--text-primary)]">Puzzle</p>
            </header>
            
            <main class="flex-grow flex flex-col justify-center gap-4 my-8">
                <button data-mode="classic" class="game-mode-btn btn btn-primary w-full py-4 rounded-xl text-lg font-bold">–ö–ª–∞—Å—Å–∏–∫–∞</button>
                <button data-mode="category" class="game-mode-btn btn btn-secondary w-full py-4 rounded-xl text-lg font-bold">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                <button id="custom-photo-btn" class="btn btn-secondary w-full py-4 rounded-xl text-lg font-bold">–°–≤–æ—ë —Ñ–æ—Ç–æ</button>
                <button id="other-games-btn" class="btn btn-other-games w-full py-4 rounded-xl text-lg font-bold">–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</button>
                <input type="file" id="image-loader" class="hidden" accept="image/*">
            </main>

            <footer class="flex justify-center gap-4">
                <button id="rules-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="stats-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </button>
                <button id="settings-btn" class="btn btn-secondary p-5 aspect-square rounded-xl flex justify-center items-center">
                    <svg class="w-8 h-8 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </footer>
        </div>

        <!-- ===== Classic Mode Size Selection Screen ===== -->
        <div id="classic-menu" class="screen hidden flex flex-col p-8">
            <header class="flex items-center mb-8">
                <button class="back-btn btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-center flex-grow -ml-12">–†–∞–∑–º–µ—Ä –ø–æ–ª—è</h2>
            </header>
            <main class="flex-grow flex flex-col justify-center gap-4">
                 <button data-size="4" class="classic-size-btn btn bg-classic-1 text-classic-1 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">4 x 4</button>
                 <button data-size="5" class="classic-size-btn btn bg-classic-2 text-classic-2 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">5 x 5</button>
                 <button data-size="6" class="classic-size-btn btn bg-classic-3 text-classic-3 w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">6 x 6</button>
            </main>
        </div>
        
        <!-- ===== Category Selection Screen ===== -->
        <div id="category-menu" class="screen hidden flex flex-col p-8">
            <header class="flex items-center mb-8">
                <button class="back-btn btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-center flex-grow -ml-12">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            </header>
            <main class="flex-grow flex flex-col justify-center gap-4">
                 <button data-category="animals" class="relative category-btn btn bg-pastel-green text-pastel-green w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">–ñ–∏–≤–æ—Ç–Ω—ã–µ<span class="level-display"></span></button>
                 <button data-category="nature" class="relative category-btn btn bg-pastel-blue text-pastel-blue w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">–ü—Ä–∏—Ä–æ–¥–∞<span class="level-display"></span></button>
                 <button data-category="cities" class="relative category-btn btn bg-pastel-yellow text-pastel-yellow w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">–ì–æ—Ä–æ–¥–∞<span class="level-display"></span></button>
                 <button data-category="cars" class="relative category-btn btn bg-pastel-red text-pastel-red w-full py-4 rounded-xl text-lg font-bold ring-2 ring-inset ring-black/10">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏<span class="level-display"></span></button>
            </main>
        </div>

        <!-- ===== Game Screen ===== -->
        <div id="game-screen" class="screen hidden flex flex-col justify-between p-4 sm:p-6">
            <header class="flex justify-between items-center w-full mb-4">
                <button id="pause-btn" class="btn btn-secondary p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <div class="flex gap-6 text-center">
                    <div>
                        <div class="text-sm font-medium text-[var(--text-secondary)]">–í—Ä–µ–º—è</div>
                        <div id="timer" class="text-xl font-bold">00:00</div>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-[var(--text-secondary)]">–•–æ–¥—ã</div>
                        <div id="moves" class="text-xl font-bold">0</div>
                    </div>
                </div>
                <div id="image-preview-container" class="w-24 h-24 rounded-lg overflow-hidden shadow-md bg-[var(--bg-tertiary)]"></div>
            </header>
            
            <main class="flex-grow flex items-center justify-center">
                <div id="puzzle-board-container" class="w-full max-w-md mx-auto">
                    <div id="puzzle-board"></div>
                </div>
            </main>

            <footer id="game-footer" class="h-16 flex items-center justify-center opacity-0 transition-opacity duration-300">
                <div class="flex items-center gap-4 bg-[var(--bg-tertiary)] py-2 px-4 rounded-full">
                    <span class="font-semibold text-sm text-[var(--text-secondary)]">–ü–æ–¥—Å–∫–∞–∑–∫–∞</span>
                     <button id="hint-toggle" class="settings-toggle relative inline-flex items-center rounded-full transition-colors">
                        <span id="hint-toggle-indicator" class="settings-toggle-indicator inline-block bg-white rounded-full transform transition-transform"></span>
                    </button>
                </div>
            </footer>
        </div>

        <!-- ===== Modals ===== -->
        <div id="rules-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-4">–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                <p class="text-[var(--text-secondary)] mb-4 text-center">
                    –¶–µ–ª—å –∏–≥—Ä—ã ‚Äî —É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –ø–ª–∏—Ç–∫–∏ –ø–æ –Ω–æ–º–µ—Ä–∞–º. –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –ø–ª–∏—Ç–∫–∏ —Ä—è–¥–æ–º —Å –ø—É—Å—Ç—ã–º –º–µ—Å—Ç–æ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∏—Ö.
                </p>
                <div id="rules-grid-example" class="aspect-square bg-[var(--bg-tertiary)] rounded-lg p-2 grid grid-cols-4 gap-1"></div>
                <button class="close-modal-btn btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
        
        <div id="other-games-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-4">–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</h2>
                <div id="other-games-container" class="grid grid-cols-3 gap-4"></div>
                <button class="close-modal-btn btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="stats-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ö–ª–∞—Å—Å–∏–∫–∞)</h2>
                <div id="stats-container" class="space-y-4"></div>
                <button class="close-modal-btn btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="settings-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <button id="theme-toggle" class="settings-toggle relative inline-flex items-center rounded-full transition-colors">
                            <span id="theme-toggle-indicator" class="settings-toggle-indicator inline-block bg-white rounded-full transform transition-transform"></span>
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">–ú—É–∑—ã–∫–∞</span>
                        <button id="music-toggle" class="settings-toggle relative inline-flex items-center rounded-full transition-colors">
                            <span id="music-toggle-indicator" class="settings-toggle-indicator inline-block bg-white rounded-full transform transition-transform"></span>
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-4 rounded-lg">
                        <span class="font-medium">–ó–≤—É–∫–∏</span>
                        <button id="sfx-toggle" class="settings-toggle relative inline-flex items-center rounded-full transition-colors">
                            <span id="sfx-toggle-indicator" class="settings-toggle-indicator inline-block bg-white rounded-full transform transition-transform"></span>
                        </button>
                    </div>
                </div>
                <button class="close-modal-btn btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>

        <div id="pause-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-8 rounded-2xl shadow-lg text-center">
                <h2 class="text-3xl font-bold mb-6">–ü–∞—É–∑–∞</h2>
                <div class="space-y-4">
                     <button id="resume-game-btn" class="btn btn-primary w-full py-3 rounded-lg font-semibold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                     <button id="restart-game-btn-pause" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                     <button id="exit-to-menu-btn-pause" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
                </div>
            </div>
        </div>

        <div id="win-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-8 rounded-2xl shadow-lg text-center">
                <div class="mb-4"><span class="text-6xl">üéâ</span></div>
                <h2 class="text-3xl font-bold mb-2">–ü–æ–±–µ–¥–∞!</h2>
                <p id="win-subtitle" class="text-[var(--text-secondary)] mb-6">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</p>
                <div class="flex justify-around bg-[var(--bg-tertiary)] p-4 rounded-lg mb-6">
                    <div class="text-center">
                        <div class="text-sm font-medium text-[var(--text-secondary)]">–í—Ä–µ–º—è</div>
                        <div id="win-time" class="text-xl font-bold">00:00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-[var(--text-secondary)]">–•–æ–¥—ã</div>
                        <div id="win-moves" class="text-xl font-bold">0</div>
                    </div>
                </div>
                 <div class="space-y-4">
                     <button id="next-level-btn-win" class="btn btn-primary w-full py-3 rounded-lg font-semibold">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
                     <button id="restart-game-btn-win" class="btn btn-primary w-full py-3 rounded-lg font-semibold">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                     <button id="exit-to-menu-btn-win" class="btn btn-secondary w-full py-3 rounded-lg font-semibold">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
                </div>
            </div>
        </div>

        <div id="alert-modal" class="modal hidden absolute inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-lg text-center">
                 <h2 id="alert-title" class="text-2xl font-bold mb-4"></h2>
                 <p id="alert-text" class="text-[var(--text-secondary)] mb-6"></p>
                 <button class="close-modal-btn btn btn-primary w-full py-3 rounded-lg mt-6 font-semibold">–û—Ç–ª–∏—á–Ω–æ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VK Bridge Initialization ---
            vkBridge.send('VKWebAppInit');
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' })
                .catch(error => console.log('Banner Ad error:', error));

            // --- DOM Elements ---
            const screens = {
                mainMenu: document.getElementById('main-menu'),
                classicMenu: document.getElementById('classic-menu'),
                categoryMenu: document.getElementById('category-menu'),
                game: document.getElementById('game-screen'),
            };
            const modals = {
                rules: document.getElementById('rules-modal'),
                stats: document.getElementById('stats-modal'),
                settings: document.getElementById('settings-modal'),
                pause: document.getElementById('pause-modal'),
                win: document.getElementById('win-modal'),
                alert: document.getElementById('alert-modal'),
                otherGames: document.getElementById('other-games-modal'),
            };
            const puzzleBoard = document.getElementById('puzzle-board');
            const timerEl = document.getElementById('timer');
            const movesEl = document.getElementById('moves');
            const imageLoader = document.getElementById('image-loader');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const gameFooter = document.getElementById('game-footer');
            const bgMusic = document.getElementById('bg-music');

            // --- Game State ---
            let state = {
                currentScreen: 'mainMenu',
                gameMode: null,
                category: null,
                currentLevel: 1,
                gridSize: 4,
                customImageSrc: null,
                board: [],
                emptyTile: { row: 3, col: 3 },
                moves: 0,
                timer: 0,
                timerInterval: null,
                isPaused: false,
                isGameActive: false,
                isRendering: false,
                theme: false, // Default theme state
                sfxEnabled: true,
                musicEnabled: true,
                hintsEnabled: false,
                levelsCompletedSinceAd: 0,
                isDataLoaded: false,
            };

            const CATEGORIES_DATA = {
                animals: { name: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', path: 'images/animals/' },
                nature: { name: '–ü—Ä–∏—Ä–æ–¥–∞', path: 'images/nature/' },
                cities: { name: '–ì–æ—Ä–æ–¥–∞', path: 'images/cities/' },
                cars: { name: '–ê–≤—Ç–æ–º–æ–±–∏–ª–∏', path: 'images/cars/' }
            };

            const BOARD_PADDING = 4;
            const TILE_GAP = 4; // Reduced gap

            // --- Sound Engine ---
            let sfxTap, sfxSlide, sfxWin;
            const initAudio = () => {
                if (sfxTap) return;
                sfxTap = new Tone.FMSynth({ harmonicity: 8, modulationIndex: 2, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.2 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 }, volume: -18 }).toDestination();
                sfxSlide = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 }, volume: -18 }).toDestination();
                sfxWin = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 3.01, modulationIndex: 14, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, volume: -10 }).toDestination();
            };
            
            const playSound = (sound) => {
                if (!state.sfxEnabled || !Tone.context.state === 'suspended') return;
                initAudio();
                const now = Tone.now();
                if (sound === 'tap') sfxTap.triggerAttackRelease("C5", "8n", now);
                if (sound === 'slide') sfxSlide.triggerAttackRelease("A5", "32n", now);
                if (sound === 'win') {
                    sfxWin.triggerAttackRelease("C5", "16n", now);
                    sfxWin.triggerAttackRelease("E5", "16n", now + 0.08);
                    sfxWin.triggerAttackRelease("G5", "16n", now + 0.16);
                    sfxWin.triggerAttackRelease("C6", "16n", now + 0.24);
                }
            };
            
            // --- VK Data Storage ---
            const saveData = async (key, value) => {
                try {
                    await vkBridge.send('VKWebAppStorageSet', { key: key, value: JSON.stringify(value) });
                } catch (error) {
                    console.error(`Failed to save key "${key}":`, error);
                }
            };

            const loadData = async (keys) => {
                try {
                    const data = await vkBridge.send('VKWebAppStorageGet', { keys: keys });
                    const loadedData = {};
                    if (data.keys) {
                        data.keys.forEach(item => {
                            try {
                                loadedData[item.key] = item.value ? JSON.parse(item.value) : null;
                            } catch (e) {
                                loadedData[item.key] = null;
                                console.log(`Could not parse JSON for key: ${item.key}`)
                            }
                        });
                    }
                    return loadedData;
                } catch (error) {
                    console.error('Failed to load keys:', error);
                    const defaultData = {};
                    keys.forEach(key => defaultData[key] = null);
                    return defaultData;
                }
            };

            // --- Image Handling ---
            const loadAndCropImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const size = Math.min(img.width, img.height);
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        const x = (img.width - size) / 2;
                        const y = (img.height - size) / 2;
                        ctx.drawImage(img, x, y, size, size, 0, 0, size, size);
                        resolve(canvas.toDataURL());
                    };
                    img.onerror = () => reject(new Error('Image could not be loaded.'));
                    img.src = src;
                });
            };

            // --- Game Logic ---
            const initGame = (mode, options) => {
                state.gameMode = mode;
                state.category = options.category || null;
                state.currentLevel = options.level || 1;
                state.customImageSrc = options.imageSrc || null;
                state.gridSize = options.size || 4;
                
                gameFooter.classList.toggle('opacity-0', mode !== 'image');
                
                updateGameHeader();
                resetGameState();
                generateBoard();
                showScreen('game');
                
                requestAnimationFrame(() => {
                    rerenderBoard(() => startGame());
                });
            };

            const updateGameHeader = () => {
                imagePreviewContainer.innerHTML = '';
                if (state.gameMode === 'image' && state.customImageSrc) {
                    const img = document.createElement('img');
                    img.src = state.customImageSrc;
                    img.className = 'w-full h-full object-cover';
                    imagePreviewContainer.appendChild(img);
                    imagePreviewContainer.classList.remove('hidden');
                } else {
                    imagePreviewContainer.classList.add('hidden');
                }
            };

            const resetGameState = () => {
                state.moves = 0;
                state.timer = 0;
                state.isPaused = false;
                state.isGameActive = true;
                movesEl.textContent = '0';
                timerEl.textContent = '00:00';
                clearInterval(state.timerInterval);
            };

            const generateBoard = () => {
                const TILE_COUNT = state.gridSize * state.gridSize;
                state.board = Array.from({ length: state.gridSize }, (_, row) => 
                    Array.from({ length: state.gridSize }, (_, col) => row * state.gridSize + col + 1)
                );
                state.board[state.gridSize-1][state.gridSize-1] = TILE_COUNT;
                state.emptyTile = { row: state.gridSize - 1, col: state.gridSize - 1 };

                let shuffleMoves = state.gridSize * state.gridSize * 10;
                for (let i = 0; i < shuffleMoves; i++) {
                    const neighbors = getNeighbors(state.emptyTile.row, state.emptyTile.col);
                    const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                    [state.board[state.emptyTile.row][state.emptyTile.col], state.board[randomNeighbor.row][randomNeighbor.col]] = 
                        [state.board[randomNeighbor.row][randomNeighbor.col], state.board[state.emptyTile.row][state.emptyTile.col]];
                    state.emptyTile = randomNeighbor;
                }
            };
            
            const rerenderBoard = (callback) => {
                if (state.isRendering) return;
                state.isRendering = true;

                if (state.gameMode === 'image' && state.customImageSrc) {
                    renderImageBoard(callback);
                } else {
                    renderClassicBoard();
                    state.isRendering = false;
                    if (callback) callback();
                }
            }

            const getTileMetrics = () => {
                const boardSize = puzzleBoard.clientWidth - (BOARD_PADDING * 2);
                const tileSize = (boardSize - (TILE_GAP * (state.gridSize - 1))) / state.gridSize;
                return { tileSize };
            };

            const getTilePosition = (row, col, tileSize) => {
                const top = BOARD_PADDING + row * (tileSize + TILE_GAP);
                const left = BOARD_PADDING + col * (tileSize + TILE_GAP);
                return { top, left };
            };
            
            const renderClassicBoard = () => {
                puzzleBoard.innerHTML = '';
                const { tileSize } = getTileMetrics();
                const TILE_COUNT = state.gridSize * state.gridSize;

                for (let row = 0; row < state.gridSize; row++) {
                    for (let col = 0; col < state.gridSize; col++) {
                        const tileValue = state.board[row][col];
                        const tile = document.createElement('div');
                        tile.classList.add('tile');
                        if (tileValue === TILE_COUNT) {
                            tile.classList.add('empty');
                        } else {
                            tile.textContent = tileValue;
                        }
                        tile.style.fontSize = `${tileSize * 0.4}px`;
                        const { top, left } = getTilePosition(row, col, tileSize);
                        tile.style.width = `${tileSize}px`;
                        tile.style.height = `${tileSize}px`;
                        tile.style.top = `${top}px`;
                        tile.style.left = `${left}px`;
                        tile.dataset.row = row;
                        tile.dataset.col = col;
                        puzzleBoard.appendChild(tile);
                    }
                }
            };

            const renderImageBoard = (callback) => {
                puzzleBoard.innerHTML = '';
                const { tileSize } = getTileMetrics();
                const TILE_COUNT = state.gridSize * state.gridSize;

                const img = new Image();
                img.onload = () => {
                    const pieceSize = img.width / state.gridSize; 
                    for (let row = 0; row < state.gridSize; row++) {
                        for (let col = 0; col < state.gridSize; col++) {
                             const tileValue = state.board[row][col];
                             const tile = document.createElement('div');
                             tile.classList.add('tile');
                            if (tileValue === TILE_COUNT) {
                                tile.classList.add('empty');
                            } else {
                                const canvas = document.createElement('canvas');
                                canvas.width = pieceSize;
                                canvas.height = pieceSize;
                                const ctx = canvas.getContext('2d');
                                const sX = ((tileValue - 1) % state.gridSize) * pieceSize;
                                const sY = Math.floor((tileValue - 1) / state.gridSize) * pieceSize;
                                ctx.drawImage(img, sX, sY, pieceSize, pieceSize, 0, 0, pieceSize, pieceSize);
                                tile.appendChild(canvas);

                                if (state.hintsEnabled) {
                                    const hint = document.createElement('span');
                                    hint.className = 'hint-number';
                                    hint.textContent = tileValue;
                                    hint.style.fontSize = `${tileSize * 0.2}px`;
                                    tile.appendChild(hint);
                                }
                            }
                            const { top, left } = getTilePosition(row, col, tileSize);
                            tile.style.width = `${tileSize}px`;
                            tile.style.height = `${tileSize}px`;
                            tile.style.top = `${top}px`;
                            tile.style.left = `${left}px`;
                            tile.dataset.row = row;
                            tile.dataset.col = col;
                            tile.dataset.value = tileValue;
                            puzzleBoard.appendChild(tile);
                        }
                    }
                    state.isRendering = false;
                    if(callback) callback();
                };
                img.onerror = () => {
                    showAlert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –ª–µ–∂–∞—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ.");
                    state.isRendering = false;
                    showScreen('mainMenu');
                }
                img.src = state.customImageSrc;
            };

            const onTileClick = (row, col) => {
                if (state.isPaused || !state.isGameActive) return;
                const { emptyTile } = state;
                const isAdjacent = Math.abs(row - emptyTile.row) + Math.abs(col - emptyTile.col) === 1;

                if (isAdjacent) {
                    playSound('slide');
                    swapTiles(row, col, emptyTile.row, emptyTile.col);
                }
            };

            const swapTiles = (row1, col1, row2, col2) => {
                [state.board[row1][col1], state.board[row2][col2]] = [state.board[row2][col2], state.board[row1][col1]];
                const tile1 = puzzleBoard.querySelector(`[data-row='${row1}'][data-col='${col1}']`);
                const tile2 = puzzleBoard.querySelector(`[data-row='${row2}'][data-col='${col2}']`);
                if (!tile1 || !tile2) return;
                const { tileSize } = getTileMetrics();
                const pos1 = getTilePosition(row1, col1, tileSize);
                const pos2 = getTilePosition(row2, col2, tileSize);
                tile1.style.top = `${pos2.top}px`;
                tile1.style.left = `${pos2.left}px`;
                tile1.dataset.row = row2;
                tile1.dataset.col = col2;
                tile2.style.top = `${pos1.top}px`;
                tile2.style.left = `${pos1.left}px`;
                tile2.dataset.row = row1;
                tile2.dataset.col = col1;
                state.emptyTile = { row: row1, col: col1 };
                updateMoves();
                if (checkWin()) {
                    endGame(true);
                }
            };

            const getNeighbors = (row, col) => {
                const neighbors = [];
                if (row > 0) neighbors.push({ row: row - 1, col });
                if (row < state.gridSize - 1) neighbors.push({ row: row + 1, col });
                if (col > 0) neighbors.push({ row, col: col - 1 });
                if (col < state.gridSize - 1) neighbors.push({ row, col: col + 1 });
                return neighbors;
            };
            
            const updateMoves = () => {
                state.moves++;
                movesEl.textContent = state.moves;
            };

            const checkWin = () => {
                let expectedValue = 1;
                const TILE_COUNT = state.gridSize * state.gridSize;
                for (let r = 0; r < state.gridSize; r++) {
                    for (let c = 0; c < state.gridSize; c++) {
                        const value = state.board[r][c];
                        if (r === state.gridSize - 1 && c === state.gridSize - 1) {
                           if (value !== TILE_COUNT) return false;
                        } else {
                           if (value !== expectedValue) return false;
                        }
                        expectedValue++;
                    }
                }
                return true;
            };
            
            const startGame = () => {
                state.isGameActive = true;
                startTimer();
            };

            const endGame = async (isWin) => {
                state.isGameActive = false;
                clearInterval(state.timerInterval);
                if (isWin) {
                    playSound('win');
                    
                    const isCategoryMode = state.gameMode === 'image' && state.category;

                    if (isCategoryMode) {
                        state.levelsCompletedSinceAd++;
                        saveData('levelsCompletedSinceAd', state.levelsCompletedSinceAd);
                        saveCategoryProgress(state.category, state.currentLevel + 1);
                    }
                    if (state.gameMode === 'classic') {
                        saveClassicStats();
                    }

                    if (isCategoryMode && state.levelsCompletedSinceAd >= 2) {
                        try {
                           await vkBridge.send('VKWebAppShowInterstitial');
                           state.levelsCompletedSinceAd = 0;
                           saveData('levelsCompletedSinceAd', 0);
                        } catch (e) {
                            console.log("Interstitial Ad error:", e);
                        }
                    }
                    
                    document.getElementById('win-time').textContent = formatTime(state.timer);
                    document.getElementById('win-moves').textContent = state.moves;
                    document.getElementById('next-level-btn-win').classList.toggle('hidden', !isCategoryMode);
                    document.getElementById('restart-game-btn-win').classList.toggle('hidden', isCategoryMode);
                    document.getElementById('win-subtitle').textContent = isCategoryMode ? `–£—Ä–æ–≤–µ–Ω—å ${state.currentLevel} –ø—Ä–æ–π–¥–µ–Ω!` : `–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!`;
                    
                    showModal('win');
                }
            };

            const startTimer = () => {
                clearInterval(state.timerInterval);
                state.timerInterval = setInterval(() => {
                    if (!state.isPaused) {
                        state.timer++;
                        timerEl.textContent = formatTime(state.timer);
                    }
                }, 1000);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            };
            
            const showScreen = (screenName) => {
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                screens[screenName].classList.remove('hidden');
                state.currentScreen = screenName;
                if(screenName === 'categoryMenu') {
                    updateCategoryLevelsUI();
                }
            };

            const showAlert = (title, text) => {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-text').textContent = text;
                showModal('alert');
            }

            const showModal = (modalName) => modals[modalName].classList.remove('hidden');
            const hideModal = (modalName) => modals[modalName].classList.add('hidden');
            const hideAllModals = () => Object.values(modals).forEach(m => m.classList.add('hidden'));

            const handleFirstInteraction = () => {
                Tone.start();
                if(state.musicEnabled && bgMusic.paused) {
                    bgMusic.play().catch(e => console.log("Music autoplay blocked"));
                }
                document.body.removeEventListener('click', handleFirstInteraction);
                document.body.removeEventListener('touchend', handleFirstInteraction);
            };
            document.body.addEventListener('click', handleFirstInteraction, { once: true });
            document.body.addEventListener('touchend', handleFirstInteraction, { once: true });

            // --- Event Listeners ---
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => playSound('tap'));
            });

            puzzleBoard.addEventListener('click', (event) => {
                if (state.isPaused || !state.isGameActive) return;
                const tile = event.target.closest('.tile');
                if (tile && !tile.classList.contains('empty')) {
                    const row = parseInt(tile.dataset.row, 10);
                    const col = parseInt(tile.dataset.col, 10);
                    onTileClick(row, col);
                }
            });

            document.querySelectorAll('.game-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    if (mode === 'classic') showScreen('classicMenu');
                    else if (mode === 'category') showScreen('categoryMenu');
                });
            });

            document.querySelectorAll('.classic-size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const size = parseInt(btn.dataset.size, 10);
                    initGame('classic', { size });
                });
            });

            document.querySelectorAll('.category-btn').forEach(async (btn) => {
                btn.addEventListener('click', async () => {
                    const category = btn.dataset.category;
                    const level = await getCategoryProgress(category);
                    
                    if (level > 60) {
                        showAlert('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', `–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${CATEGORIES_DATA[category].name}". –ù–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!`);
                        return;
                    }

                    let size;
                    if (level <= 20) size = 4;
                    else if (level <= 40) size = 5;
                    else size = 6;
                    
                    try {
                        const imagePath = `${CATEGORIES_DATA[category].path}${level}.jpg`;
                        const croppedImageSrc = await loadAndCropImage(imagePath);
                        initGame('image', { category, imageSrc: croppedImageSrc, size, level });
                    } catch (error) {
                        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è.');
                    }
                });
            });
            
            document.getElementById('custom-photo-btn').addEventListener('click', () => imageLoader.click());
            imageLoader.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const croppedImageSrc = await loadAndCropImage(event.target.result);
                            initGame('image', { imageSrc: croppedImageSrc, size: 4 });
                        } catch (error) {
                            showAlert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
                        }
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => showScreen('mainMenu'));
            });
            
            document.getElementById('rules-btn').addEventListener('click', () => showModal('rules'));
            document.getElementById('stats-btn').addEventListener('click', () => { renderStats(); showModal('stats'); });
            document.getElementById('settings-btn').addEventListener('click', () => showModal('settings'));
            document.getElementById('other-games-btn').addEventListener('click', () => showModal('otherGames'));
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                       modal.classList.add('hidden');
                    }
                });
            });
            
            document.getElementById('pause-btn').addEventListener('click', () => { state.isPaused = true; showModal('pause'); });
            document.getElementById('resume-game-btn').addEventListener('click', () => { state.isPaused = false; hideModal('pause'); });
            
            const restartGame = async () => {
                hideAllModals();
                const options = { 
                    size: state.gridSize, 
                    category: state.category, 
                    level: state.currentLevel, 
                    imageSrc: state.customImageSrc
                };
                initGame(state.gameMode, options);
            };

            document.getElementById('restart-game-btn-pause').addEventListener('click', restartGame);
            document.getElementById('restart-game-btn-win').addEventListener('click', restartGame);
            document.getElementById('next-level-btn-win').addEventListener('click', async () => {
                hideAllModals();
                const nextLevel = state.currentLevel + 1;
                if (nextLevel > 60) {
                     showAlert('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', `–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${CATEGORIES_DATA[state.category].name}". –ù–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!`);
                     showScreen('mainMenu');
                     return;
                }
                let size;
                if (nextLevel <= 20) size = 4;
                else if (nextLevel <= 40) size = 5;
                else size = 6;
                
                try {
                    const imagePath = `${CATEGORIES_DATA[state.category].path}${nextLevel}.jpg`;
                    const croppedImageSrc = await loadAndCropImage(imagePath);
                    initGame('image', { category: state.category, imageSrc: croppedImageSrc, size, level: nextLevel });
                } catch (error) {
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è.');
                    showScreen('mainMenu');
                }
            });

            const exitToMenu = () => {
                hideAllModals();
                showScreen('mainMenu');
            };
            document.getElementById('exit-to-menu-btn-pause').addEventListener('click', exitToMenu);
            document.getElementById('exit-to-menu-btn-win').addEventListener('click', exitToMenu);
            
            // --- Settings Toggles ---
            const setupToggle = (toggleEl, indicatorEl, initialValue, onToggle) => {
                let isEnabled = initialValue;
                const applyState = (enabled) => {
                    // Corrected transform value for w-11 container and w-4 indicator with p-1 on container
                    indicatorEl.style.transform = enabled ? 'translateX(1.25rem)' : 'translateX(0rem)';
                    // Use specific contrasting colors for off-state to avoid merging.
                    if (enabled) {
                        toggleEl.classList.add('bg-[var(--accent-primary)]');
                        toggleEl.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    } else {
                        toggleEl.classList.remove('bg-[var(--accent-primary)]');
                        toggleEl.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    }
                    onToggle(enabled);
                };
                applyState(isEnabled);
                toggleEl.addEventListener('click', () => {
                    isEnabled = !isEnabled;
                    applyState(isEnabled);
                });
                return applyState;
            };
            
            const setupPersistentToggle = (toggleId, indicatorId, storageKey, onToggle) => {
                const toggle = document.getElementById(toggleId);
                const indicator = document.getElementById(indicatorId);
                const updateUI = setupToggle(toggle, indicator, state[storageKey], (isEnabled) => {
                    state[storageKey] = isEnabled; 
                    saveData(storageKey, isEnabled);
                    onToggle(isEnabled);
                });
                return updateUI;
            };

            const setupAllToggles = () => {
                 setupPersistentToggle('theme-toggle', 'theme-toggle-indicator', 'theme', (isDark) => {
                     document.documentElement.classList.toggle('dark', isDark);
                     document.documentElement.classList.toggle('light', !isDark);
                });
                setupPersistentToggle('music-toggle', 'music-toggle-indicator', 'musicEnabled', (isEnabled) => {
                    if (isEnabled) {
                       bgMusic.play().catch(e=>console.log("Music autoplay blocked"));
                    } else {
                        bgMusic.pause();
                    }
                });
                setupPersistentToggle('sfx-toggle', 'sfx-toggle-indicator', 'sfxEnabled', (isEnabled) => {});

                const hintToggle = document.getElementById('hint-toggle');
                const hintIndicator = document.getElementById('hint-toggle-indicator');
                setupToggle(hintToggle, hintIndicator, state.hintsEnabled, (isEnabled) => {
                    state.hintsEnabled = isEnabled;
                    if (state.isGameActive && state.gameMode === 'image') {
                        rerenderBoard(() => {});
                    }
                });
            }
            
            // --- Category Progress & UI Update ---
            const getCategoryProgress = async (category) => {
                const progressData = await loadData(['puzzle-progress']);
                const progress = progressData['puzzle-progress'] || {};
                return progress[category] || 1;
            };
            const saveCategoryProgress = async (category, level) => {
                const progressData = await loadData(['puzzle-progress']);
                const progress = progressData['puzzle-progress'] || {};
                progress[category] = level;
                await saveData('puzzle-progress', progress);
            };

            const updateCategoryLevelsUI = async () => {
                 const progressData = await loadData(['puzzle-progress']);
                 const progress = progressData['puzzle-progress'] || {};
                 document.querySelectorAll('.category-btn').forEach(btn => {
                    const category = btn.dataset.category;
                    const level = progress[category] || 1;
                    btn.querySelector('.level-display').textContent = `–£—Ä. ${level}`;
                 });
            };

            // --- Statistics ---
            const getClassicStats = async () => {
                const statsData = await loadData(['puzzle-stats-classic']);
                return statsData['puzzle-stats-classic'] || {};
            };
            const saveClassicStats = async () => {
                const statsKey = `classic-${state.gridSize}x${state.gridSize}`;
                const stats = await getClassicStats();
                if (!stats[statsKey]) {
                    stats[statsKey] = { bestTime: null, wins: 0 };
                }
                const current = stats[statsKey];
                if (current.bestTime === null || state.timer < current.bestTime) current.bestTime = state.timer;
                current.wins++;
                await saveData('puzzle-stats-classic', stats);
            };
            
            const renderStats = async () => {
                const stats = await getClassicStats();
                const container = document.getElementById('stats-container');
                const modes = { 'classic-4x4': '4x4', 'classic-5x5': '5x5', 'classic-6x6': '6x6' };
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="text-xs text-[var(--text-secondary)] uppercase"><th class="py-2 px-2">–†–∞–∑–º–µ—Ä</th><th class="py-2 px-2 text-center">–ü–æ–±–µ–¥</th><th class="py-2 px-2 text-center">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</th></tr></thead><tbody>`;
                for (const key in modes) {
                    const data = stats[key] || { wins: 0, bestTime: null };
                    tableHTML += `<tr class="border-t border-[var(--bg-tertiary)]"><td class="py-3 px-2 font-bold">${modes[key]}</td><td class="py-3 px-2 text-center">${data.wins}</td><td class="py-3 px-2 text-center">${data.bestTime !== null ? formatTime(data.bestTime) : '-'}</td></tr>`;
                }
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            };
            
            // --- Other Games Modal (FIXED) ---
            const renderOtherGames = () => {
                const games = [
                    { id: 54051411, name: 'Bubble Shooter', icon: 'icon1.png' },
                    { id: 54051413, name: '–¢–µ—Ç—Ä–∏—Å', icon: 'icon2.png' },
                    { id: 53962513, name: 'Tower Blocks', icon: 'icon3.png' },
                    { id: 53936296, name: '–ë–ª–æ–∫ –ü—Ä–æ', icon: 'icon4.png' },
                    { id: 53867134, name: '–§–∏–ª–≤–æ—Ä–¥—ã', icon: 'icon5.png' },
                    { id: 53861990, name: '–°–ª–æ–≤–ª–∏', icon: 'icon6.png' },
                    { id: 54023580, name: 'Brick Balls', icon: 'icon7.png' },
                    { id: 53965380, name: '2048', icon: 'icon8.png' },
                    { id: 54143992, name: 'Sort Puzzle', icon: 'icon9.png' }
                ];
                const container = document.getElementById('other-games-container');
                container.innerHTML = '';
                games.forEach(game => {
                    const gameEl = document.createElement('div');
                    gameEl.className = 'flex flex-col items-center gap-2 p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors cursor-pointer group';
                    gameEl.onclick = () => vkBridge.send('VKWebAppOpenApp', { app_id: game.id });
                    gameEl.innerHTML = `
                        <div class="w-16 h-16 rounded-xl shadow-md overflow-hidden group-hover:scale-105 transition-transform">
                             <img src="icons/${game.icon}" alt="${game.name}" class="w-full h-full object-cover">
                        </div>
                        <span class="text-xs font-medium text-center">${game.name}</span>
                    `;
                    container.appendChild(gameEl);
                });
            };

            // --- Misc UI Generation ---
            const generateRulesGrid = () => {
                const container = document.getElementById('rules-grid-example');
                container.innerHTML = '';
                for (let i = 1; i <= 15; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'rules-grid-cell bg-[var(--bg-secondary)] rounded-md flex items-center justify-center font-bold text-[var(--accent-primary)]';
                    cell.textContent = i;
                    container.appendChild(cell);
                }
                const emptyCell = document.createElement('div');
                emptyCell.className = 'rules-grid-cell rounded-md';
                container.appendChild(emptyCell);
            };
            
            // --- Initialization (FIXED) ---
            const initializeApp = async () => {
                const storedData = await loadData(['theme', 'musicEnabled', 'sfxEnabled', 'levelsCompletedSinceAd']);
                
                state.musicEnabled = storedData.musicEnabled !== null ? storedData.musicEnabled : true;
                state.sfxEnabled = storedData.sfxEnabled !== null ? storedData.sfxEnabled : true;
                state.levelsCompletedSinceAd = storedData.levelsCompletedSinceAd || 0;
                // FIX: Assign loaded theme to the global state object BEFORE setting up toggles
                state.theme = storedData.theme !== null ? storedData.theme : false;

                // Apply the theme class to the document
                document.documentElement.classList.toggle('dark', state.theme);
                document.documentElement.classList.toggle('light', !state.theme);

                state.isDataLoaded = true;
                
                // Now setupAllToggles will read the correct initial theme from the state
                setupAllToggles();
                generateRulesGrid();
                renderOtherGames();

                vkBridge.subscribe(({ detail: { type, data }}) => {
                    if (type === 'VKWebAppViewHide') {
                        bgMusic.pause();
                    }
                    if (type === 'VKWebAppViewRestore') {
                        if (state.musicEnabled) {
                            bgMusic.play().catch(e => console.log("Music play failed on restore"));
                        }
                    }
                });
            };
            
            initializeApp();

            const resizeObserver = new ResizeObserver(() => {
                if (state.currentScreen === 'game' && state.isGameActive) {
                    rerenderBoard(() => {});
                }
            });
            resizeObserver.observe(document.getElementById('puzzle-board-container'));

        });
    </script>
</body>
</html>
